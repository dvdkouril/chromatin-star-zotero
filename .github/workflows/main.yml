name: Process Zotero lib to JSON (to Cloudflare)
  
on:
  push:
    branches: 'main'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
      R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
    steps:
      - uses: actions/checkout@v4
      # install uv and deno
      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "0.4.x"
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Fetch Zotero collection
        run: deno run -A fetch-zotero.ts # produces `papers.json`

      - name: Verify papers.json was created
        run: |
          if [ ! -f papers.json ]; then
            echo "Error: papers.json was not created"
            exit 1
          fi
          echo "papers.json exists:"
          ls -lh papers.json

      - name: Upload papers.json to Cloudflare R2
        run: |
          uv run --with awscli aws s3 cp papers.json "s3://${R2_BUCKET_NAME}/papers.json" \
            --endpoint-url "${R2_ENDPOINT_URL}"
          echo "Upload completed successfully"
